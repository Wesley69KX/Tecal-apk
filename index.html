<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Status das Torres</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1677ff">

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/service-worker.js");
    }
  </script>

  <link rel="stylesheet" href="style.css">
</head>

<body>
  <!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>Painel de Torres ‚Äì Dashboard Moderno</title>

  <style>
    /* ------------------------------------
       TEMA CLARO CORPORATIVO ‚Äì DASHBOARD
    --------------------------------------*/
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      color: #333;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1500px;
      margin: 25px auto;
      padding: 25px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.12);
    }

    /* HEADER */
    .header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-bottom: 2px solid #0066cc;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    h1 {
      margin: 0;
      font-size: 2.1rem;
      color: #0066cc;
      font-weight: 700;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      background: #e9eef3;
      padding: 14px;
      border-radius: 10px;
      border: 1px solid #cfd8e3;
    }

    select, input, button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ccd3db;
      background: #fff;
      font-size: 0.95rem;
      color: #333;
      cursor: pointer;
    }

    button.btn {
      background: #0066cc;
      color: #fff;
      font-weight: 600;
      border: none;
    }
    button.btn:hover {
      background: #004c99;
    }

    /* PAINEL DE CARDS */
    #towers-panel {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 22px;
    }

    @media(max-width: 900px) {
      #towers-panel { grid-template-columns: 1fr; }
    }

    /* CARD BASE */
    .tower-card {
      background: #fff;
      border-radius: 14px;
      padding: 22px;
      box-shadow: 0 5px 12px rgba(0,0,0,0.08);
      border: 1px solid #d9dfe6;
      transition: 0.25s;
    }

    .tower-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.10);
    }

    /* ALERTA DE PEND√äNCIA */
    .tower-card.alert-pending {
      border: 3px solid #ffca28 !important;
      background: #fff8d1 !important;
      box-shadow: 0 0 12px rgba(255, 193, 7, 0.45) !important;
    }

    .pend-banner {
      font-size: 0.90rem;
      padding: 8px;
      margin-bottom: 12px;
      border-radius: 6px;
      background: #ffe9a3;
      border: 1px solid #e6b800;
      font-weight: 600;
      color: #664d00;
    }

    /* CARD HEADER */
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .title-area h2 {
      margin: 0;
      font-size: 1.45rem;
      font-weight: 700;
      color: #0066cc;
    }

    .status-pill {
      padding: 6px 15px;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 700;
      color: #fff;
    }

    .status-Operando { background: #28a745; }
    .status-Falha { background: #dc3545; }
    .status-Offline { background: #ff9800; }

    /* SE√á√ïES DO CARD */
    .section-box {
      background: #f9fafc;
      border: 1px solid #d9dfe6;
      padding: 15px;
      border-radius: 10px;
      margin-top: 12px;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 700;
      color: #0066cc;
      margin-bottom: 10px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 0.93rem;
    }

    .row strong {
      min-width: 155px;
      color: #333;
    }

    /* BOT√ÉO EDITAR */
    .edit-btn {
      margin-top: 14px;
      padding: 10px 16px;
      background: #0066cc;
      color: #fff;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }

    .edit-btn:hover {
      background: #004c99;
    }

    /* MODAL */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal.show { display: flex; }

    .modal-card {
      width: 600px;
      max-width: 95%;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.20);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-card h3 {
      margin-top: 0;
      color: #0066cc;
    }

    .modal-card label {
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
    }

    .modal-card input,
    .modal-card select,
    .modal-card textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccd3db;
      border-radius: 8px;
      background: #fff;
      margin-bottom: 12px;
      font-size: 0.95rem;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn-danger {
      background: #d9534f;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-danger:hover {
      background: #b52b27;
    }

  </style>
</head>

<body onload="checkLogin()">

<div class="container">
  <div class="header">
    <div class="header-title">
      <img src="https://ssl.gstatic.com/docs/doc_assets/images/drive_48.png" width="45">
      <h1>üõ∞Ô∏è Painel de Torres ‚Äì Dashboard</h1>
    </div>

    <div class="controls">
      <label>Status:
        <select id="filterStatus">
          <option value="all">Todos</option>
          <option value="Operando">Operando</option>
          <option value="Falha">Falha</option>
          <option value="Offline">Offline</option>
        </select>
      </label>

      <label>Auto-refresh (s):
        <input id="refreshInterval" type="number" min="5" value="20" style="width:70px">
      </label>

      <button class="btn" id="btnRefresh">üîÅ Atualizar</button>
      <button class="btn" id="btnExport">üì§ PDF</button>
    </div>
  </div>

  <div id="towers-panel"></div>
</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal">
  <div class="modal-card">
    <h3>Editar Torre: <span id="editName"></span></h3>

    <label>Torre</label>
    <input id="editTorre" disabled>

    <label>Localiza√ß√£o</label>
    <input id="editLocalizacao">

    <label>Status Operacional</label>
    <select id="editStatus">
      <option>Operando</option>
      <option>Falha</option>
      <option>Offline</option>
    </select>

    <label>Falha Detectada</label>
    <input id="editFalha">

    <label>Hist√≥rico de Falha</label>
    <textarea id="editHistorico"></textarea>

    <label>A√ß√£o Requerida</label>
    <input id="editAcao">

    <label>T√©cnico Respons√°vel</label>
    <input id="editTecnico">

    <label>Data da √öltima Manuten√ß√£o</label>
    <input type="date" id="editDataManutencao">

    <label>Custo (R$)</label>
    <input type="number" step="0.01" id="editCusto">

    <label>Pe√ßas Utilizadas</label>
    <input id="editPecas">

    <label>Pr√≥xima Manuten√ß√£o</label>
    <input type="date" id="editProxManutencao">

    <label>Pend√™ncia de Servi√ßo</label>
    <textarea id="editPendServico"></textarea>

    <label>Pend√™ncia de Material</label>
    <textarea id="editPendMaterial"></textarea>

    <label>Observa√ß√µes</label>
    <textarea id="editObs"></textarea>

    <div class="modal-actions">
      <button class="btn" id="saveEdit">Salvar</button>
      <button class="btn-danger" id="cancelEdit">Cancelar</button>
    </div>
  </div>
</div>

<!-- LOGIN MODAL -->
<div class="modal" id="loginModal">
  <div class="modal-card">
    <h3>üîí Login</h3>
    <p>Informe a senha para acessar o painel.</p>
    <input type="password" id="loginPass" placeholder="Senha">
    <div class="modal-actions">
      <button class="btn" id="btnLogin">Entrar</button>
    </div>
  </div>
</div>

<script>
/* --------------------------
     VARI√ÅVEIS GLOBAIS
---------------------------*/
let towers = [];
let autoRefreshTimer = null;

/* --------------------------
     LOGIN
---------------------------*/
function checkLogin() {
  google.script.run
    .withSuccessHandler(function(isAuth) {
      if (isAuth === true) {
        document.getElementById("loginModal").classList.remove("show");
        loadTowers();
      } else {
        document.getElementById("loginModal").classList.add("show");
      }
    })
    .checkPassword(null);
}

document.getElementById("btnLogin").onclick = function () {
  const pass = document.getElementById("loginPass").value;
  google.script.run
    .withSuccessHandler(function(ok){
      if(ok === true){
        document.getElementById("loginModal").classList.remove("show");
        loadTowers();
      } else {
        alert("Senha incorreta.");
      }
    })
    .checkPassword(pass);
};

/* --------------------------
     LOAD + RENDER
---------------------------*/
function loadTowers() {
  google.script.run
    .withSuccessHandler(function(data){
      towers = data || [];
      render();
    })
    .getTowers();
}

function render() {
  const panel = document.getElementById("towers-panel");
  panel.innerHTML = "";

  const filter = document.getElementById("filterStatus").value;

  towers
    .filter(t => filter === "all" || t["Status Operacional"] === filter)
    .forEach(t => panel.appendChild(renderCard(t)));
}

/* --------------------------
      CARD
---------------------------*/
function renderCard(t) {
  const pendServ = t["Pend√™ncia de Servi√ßo"] ? String(t["Pend√™ncia de Servi√ßo"]).trim() : "";
  const pendMat  = t["Pend√™ncia de Material"] ? String(t["Pend√™ncia de Material"]).trim() : "";

  const hasPending = (pendServ !== "" || pendMat !== "");

  const card = document.createElement("div");
  card.className = "tower-card";
  if (hasPending) card.classList.add("alert-pending");

  // √çcone do status
  let icon = "üü¢";
  if (t["Status Operacional"] === "Falha") icon = "üî¥";
  if (t["Status Operacional"] === "Offline") icon = "üü†";
  if (hasPending) icon = "üîî";

  card.innerHTML = `
    <div class="card-header">
      <div class="title-area">
        <h2>${icon} ${t.Torre}</h2>
      </div>
      <div class="status-pill status-${t["Status Operacional"]}">
        ${t["Status Operacional"]}
      </div>
    </div>

    ${hasPending ? `<div class="pend-banner">‚ö† Pend√™ncias encontradas ‚Äî verifique!</div>` : ""}

    <div class="section-box">
      <div class="section-title">Informa√ß√µes Gerais</div>
      <div class="row"><strong>Localiza√ß√£o:</strong> ${t.Localiza√ß√£o || "‚Äî"}</div>
      <div class="row"><strong>Prioridade:</strong> ${t.Prioridade || "‚Äî"}</div>
      <div class="row"><strong>T√©cnico:</strong> ${t["T√©cnico Respons√°vel"] || "‚Äî"}</div>
      <div class="row"><strong>√öltima Comunica√ß√£o:</strong> ${t["√öltima Comunica√ß√£o"] || "‚Äî"}</div>
    </div>

    <div class="section-box">
      <div class="section-title">Falhas e A√ß√µes</div>
      <div class="row"><strong>Falha Detectada:</strong> ${t["Falha Detectada"] || "‚Äî"}</div>
      <div class="row"><strong>Hist√≥rico de Falha:</strong> ${t["Hist√≥rico de Falha"] || "‚Äî"}</div>
      <div class="row"><strong>A√ß√£o Requerida:</strong> ${t["A√ß√£o Requerida"] || "‚Äî"}</div>
    </div>

    <div class="section-box">
      <div class="section-title">Manuten√ß√£o</div>
      <div class="row"><strong>√öltima Manuten√ß√£o:</strong> ${t["Data da √öltima Manuten√ß√£o"] || "‚Äî"}</div>
      <div class="row"><strong>Custo:</strong> ${t["Custo da √öltima Manuten√ß√£o (R$)"] || "‚Äî"}</div>
      <div class="row"><strong>Pe√ßas Utilizadas:</strong> ${t["Pe√ßas Utilizadas"] || "‚Äî"}</div>
      <div class="row"><strong>Pr√≥xima Manuten√ß√£o:</strong> ${t["Pr√≥xima Manuten√ß√£o"] || "‚Äî"}</div>
    </div>

    <div class="section-box">
      <div class="section-title">Pend√™ncias</div>
      <div class="row"><strong>Pend. Servi√ßo:</strong> ${pendServ || "‚Äî"}</div>
      <div class="row"><strong>Pend. Material:</strong> ${pendMat || "‚Äî"}</div>
    </div>

    <div class="section-box">
      <div class="section-title">Observa√ß√µes</div>
      <div class="row"><strong>Obs:</strong> ${t["Observa√ß√µes"] || "‚Äî"}</div>
    </div>

    <button class="edit-btn" onclick="openEdit('${t.Torre}')">‚úèÔ∏è Editar</button>
  `;

  return card;
}

/* --------------------------
     OPEN EDIT MODAL
---------------------------*/
function openEdit(torre) {
  const t = towers.find(x => x.Torre === torre);
  if (!t) return alert("Erro ao localizar torre.");

  document.getElementById("editName").innerText = torre;
  document.getElementById("editTorre").value = t.Torre;
  document.getElementById("editLocalizacao").value = t.Localiza√ß√£o || "";
  document.getElementById("editStatus").value = t["Status Operacional"] || "";
  document.getElementById("editFalha").value = t["Falha Detectada"] || "";
  document.getElementById("editHistorico").value = t["Hist√≥rico de Falha"] || "";
  document.getElementById("editAcao").value = t["A√ß√£o Requerida"] || "";
  document.getElementById("editTecnico").value = t["T√©cnico Respons√°vel"] || "";
  document.getElementById("editDataManutencao").value = t["Data da √öltima Manuten√ß√£o"] || "";
  document.getElementById("editCusto").value = t["Custo da √öltima Manuten√ß√£o (R$)"] || "";
  document.getElementById("editPecas").value = t["Pe√ßas Utilizadas"] || "";
  document.getElementById("editProxManutencao").value = t["Pr√≥xima Manuten√ß√£o"] || "";
  document.getElementById("editPendServico").value = t["Pend√™ncia de Servi√ßo"] || "";
  document.getElementById("editPendMaterial").value = t["Pend√™ncia de Material"] || "";
  document.getElementById("editObs").value = t["Observa√ß√µes"] || "";

  document.getElementById("editModal").classList.add("show");
}

document.getElementById("cancelEdit").onclick = () => {
  document.getElementById("editModal").classList.remove("show");
};

/* --------------------------
     SAVE EDIT
---------------------------*/
document.getElementById("saveEdit").onclick = function () {
  const updates = {
    "Localiza√ß√£o": document.getElementById("editLocalizacao").value,
    "Status Operacional": document.getElementById("editStatus").value,
    "Falha Detectada": document.getElementById("editFalha").value,
    "Hist√≥rico de Falha": document.getElementById("editHistorico").value,
    "A√ß√£o Requerida": document.getElementById("editAcao").value,
    "T√©cnico Respons√°vel": document.getElementById("editTecnico").value,
    "Data da √öltima Manuten√ß√£o": document.getElementById("editDataManutencao").value,
    "Custo da √öltima Manuten√ß√£o (R$)": document.getElementById("editCusto").value,
    "Pe√ßas Utilizadas": document.getElementById("editPecas").value,
    "Pr√≥xima Manuten√ß√£o": document.getElementById("editProxManutencao").value,
    "Pend√™ncia de Servi√ßo": document.getElementById("editPendServico").value,
    "Pend√™ncia de Material": document.getElementById("editPendMaterial").value,
    "Observa√ß√µes": document.getElementById("editObs").value,
    "√öltima Comunica√ß√£o": new Date().toISOString()
  };

  google.script.run
    .withSuccessHandler(function(){
      document.getElementById("editModal").classList.remove("show");
      loadTowers();
    })
    .updateTower({ Torre: document.getElementById("editTorre").value, updates });
};

/* --------------------------
     EVENTOS
---------------------------*/
document.getElementById("btnRefresh").onclick = loadTowers;

document.getElementById("filterStatus").onchange = render;

document.getElementById("refreshInterval").onchange = function() {
  clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(loadTowers, this.value * 1000);
};

document.getElementById("btnExport").onclick = function () {
  google.script.run
    .withSuccessHandler(function(res){
      if(res && res.url) window.open(res.url, "_blank");
    })
    .exportPdf();
};

</script>
<script src="offline.js"></script>
  <script src="script.js"></script>
</body>
</html>
