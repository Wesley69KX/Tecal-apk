<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Torres - V2</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #0056b3;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #343a40;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; }
        
        /* Utilit√°rios */
        .hidden { display: none !important; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn:hover { opacity: 0.9; }

        /* Status de Conex√£o */
        .status-badge { position: fixed; top: 10px; right: 10px; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; z-index: 9999; }
        .status-badge.online { background-color: var(--success); color: white; }
        .status-badge.offline { background-color: var(--secondary); color: white; }

        /* Telas de Login e Sele√ß√£o */
        .fullscreen-center { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #0056b3, #003d80); color: white; }
        .login-box { background: white; padding: 30px; border-radius: 10px; color: var(--dark); width: 90%; max-width: 350px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .login-logo { max-width: 150px; margin-bottom: 20px; display: none; margin-left: auto; margin-right: auto; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 14px; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        .location-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-top: 20px; }
        .btn-loc { padding: 20px; font-size: 16px; background: var(--light); border: 2px solid var(--primary); color: var(--primary); border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-loc:hover { background: var(--primary); color: white; }

        /* App Principal */
        #app-content { display: none; padding-bottom: 50px; }
        .app-header { background: white; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-title h1 { margin: 0; font-size: 20px; color: var(--primary); }
        .header-title span { font-size: 12px; color: var(--secondary); }
        .header-controls { display: flex; gap: 10px; }

        .toolbar { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .search-box { flex: 1; max-width: 400px; }
        .search-box input { width: 100%; padding: 10px; border-radius: 20px; border: 1px solid #ccc; outline: none; padding-left: 15px; }

        .stats-bar { padding: 0 20px; font-size: 14px; color: var(--secondary); margin-bottom: 10px; }

        /* Grid de Cards */
        .tower-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
        .card { background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; transition: transform 0.2s; border-left: 5px solid var(--secondary); }
        .card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Cores dos Status */
        .st-Operando { border-left-color: var(--success); }
        .st-Falha { border-left-color: var(--danger); }
        .st-Manuten√ß√£o { border-left-color: var(--warning); }
        .st-Desativada { border-left-color: var(--secondary); }

        .card-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .status-pill { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; background: #eee; }
        .warning-alert { background: #fff3cd; color: #856404; padding: 5px 15px; font-size: 12px; border-bottom: 1px solid #ffeeba; }
        
        .card-body { padding: 15px; font-size: 13px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .info-item { display: flex; flex-direction: column; }
        .info-label { color: #888; font-size: 11px; }
        .info-value { font-weight: 500; }
        .text-red { color: var(--danger); font-weight: bold; }
        
        .divider { grid-column: 1 / -1; height: 1px; background: #eee; margin: 5px 0; }
        .obs-box { margin-top: 10px; background: #f8f9fa; padding: 8px; border-radius: 4px; font-style: italic; color: #555; }

        .card-footer { padding: 10px 15px; background: #fafafa; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-card { padding: 5px 10px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-edit { color: var(--primary); border-color: var(--primary); }
        .btn-pdf-single { color: var(--danger); border-color: var(--danger); }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; margin: 20px auto; padding: 20px; width: 95%; max-width: 800px; border-radius: 8px; position: relative; }
        .close { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; }
        
        .form-section { margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 5px; }
        .form-section h3 { margin-top: 0; color: var(--primary); font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 10px; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        .photo-area { margin-top: 10px; border: 2px dashed #ddd; padding: 20px; text-align: center; }
        .preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .photo-wrapper { position: relative; width: 80px; height: 80px; }
        .img-preview { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .btn-delete-photo { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 18px; cursor: pointer; font-size: 12px; }

        /* Checklist */
        #checklist-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; flex-direction: column; overflow-y: auto; }
        .chk-header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .chk-body { padding: 20px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        
        .chk-meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        
        .check-section { background: #eee; padding: 8px 15px; margin: 15px 0 5px 0; font-weight: bold; border-radius: 4px; }
        .chk-row { display: flex; flex-wrap: wrap; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; gap: 10px; }
        .chk-title { flex: 2; min-width: 250px; font-size: 14px; }
        .chk-controls { flex: 1; min-width: 150px; }
        .chk-comment { flex: 1; min-width: 150px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        
        .radio-group { display: flex; gap: 15px; }
        .radio-label { font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        .signature-area { margin-top: 30px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; }
        .signature-pad-wrapper { border: 1px dashed #999; height: 200px; background: #fff; position: relative; margin-top: 10px; }
        canvas { width: 100%; height: 100%; display: block; }
    </style>
</head>
<body>

    <div id="connection-status" class="status-badge online">Online</div>

    <div id="login-screen" class="fullscreen-center">
        <div class="login-box">
            <img id="login-logo-view" class="login-logo" src="" alt="Logo">
            <h2>Gest√£o de Torres</h2>
            <div class="input-group">
                <label>Usu√°rio</label>
                <input type="text" id="login-user" placeholder="Digite seu usu√°rio">
            </div>
            <div class="input-group">
                <label>Senha</label>
                <input type="password" id="login-pass" placeholder="Digite sua senha">
            </div>
            <button class="btn btn-primary" onclick="app.checkLogin()" style="width:100%">Entrar</button>
            <hr style="margin: 20px 0; border-color: #eee;">
            <button class="btn btn-success" onclick="app.visitorLogin()" style="width:100%">Entrar como Visitante</button>
        </div>
    </div>

    <div id="location-screen" class="fullscreen-center hidden">
        <div class="login-box" style="max-width: 500px;">
            <h3>Selecione a Localidade</h3>
            <p>Escolha a unidade para carregar os dados:</p>
            <div class="location-grid">
                <button class="btn-loc" onclick="app.selectLocation('MSG')">MSG<br><small>Crix√°s</small></button>
                <button class="btn-loc" onclick="app.selectLocation('QUEIROZ')">QUEIROZ<br><small>Raposos</small></button>
                <button class="btn-loc" onclick="app.selectLocation('CUIABA')">CUIAB√Å<br><small>Sabar√°</small></button>
                <button class="btn-loc" onclick="app.selectLocation('RPX')">RPX<br><small>Raposos</small></button>
            </div>
            <button class="btn btn-danger" style="margin-top:20px" onclick="location.reload()">Voltar / Sair</button>
        </div>
    </div>

    <div id="app-content">
        <div class="app-header">
            <div class="header-title">
                <h1>Painel de Controle</h1>
                <span>Unidade: <strong id="current-loc-badge">---</strong></span>
            </div>
            <div class="header-controls">
                <button class="btn btn-danger" onclick="location.reload()">Sair</button>
            </div>
        </div>

        <div class="toolbar">
            <div class="search-box">
                <input type="text" id="search" placeholder="Buscar torre..." onkeyup="app.filterList()">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-success" id="btn-new-checklist" onclick="app.openChecklist()">+ Novo Checklist</button>
                <button class="btn btn-primary" onclick="app.generateGlobalPDF()">üìÑ Relat√≥rio Geral</button>
                <button class="btn btn-primary" onclick="app.generateMonthlyPDF()">üìÖ Relat√≥rio Mensal</button>
            </div>
        </div>

        <div class="stats-bar">
            Total de Torres: <strong id="total-card">0</strong> | <span id="loading-msg">Carregando dados...</span>
        </div>

        <div id="tower-list" class="tower-grid">
            </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="app.closeModal()">&times;</span>
            <h2>Editar Torre</h2>
            <form id="tower-form" onsubmit="app.saveTower(event)">
                <input type="hidden" id="tower-id">
                
                <div class="form-section">
                    <h3>Identifica√ß√£o</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nome da Torre</label>
                            <input type="text" id="f-nome" required>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="f-status">
                                <option value="Operando">Operando</option>
                                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                                <option value="Falha">Falha</option>
                                <option value="Desativada">Desativada</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Geral</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Localiza√ß√£o</label><input type="text" id="f-geral-local"></div>
                        <div class="form-group"><label>Prioridade</label>
                            <select id="f-geral-prio">
                                <option value="Baixa">Baixa</option>
                                <option value="M√©dia">M√©dia</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        <div class="form-group"><label>T√©cnico Resp.</label><input type="text" id="f-geral-tec"></div>
                        <div class="form-group"><label>√öltima Comunica√ß√£o</label><input type="datetime-local" id="f-geral-ultimacom"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Falhas</h3>
                    <div class="form-group"><label>Falha Detectada</label><input type="text" id="f-falhas-detectada"></div>
                    <div class="form-group"><label>Hist√≥rico</label><textarea id="f-falhas-historico" rows="2"></textarea></div>
                    <div class="form-group"><label>A√ß√£o Tomada</label><input type="text" id="f-falhas-acao"></div>
                </div>

                <div class="form-section">
                    <h3>Manuten√ß√£o</h3>
                    <div class="form-row">
                        <div class="form-group"><label>√öltima Manut.</label><input type="date" id="f-manu-ultima"></div>
                        <div class="form-group"><label>Pr√≥xima Manut.</label><input type="date" id="f-manu-proxima"></div>
                        <div class="form-group"><label>Custo Estimado</label><input type="text" id="f-manu-custo"></div>
                    </div>
                    <div class="form-group"><label>Pe√ßas Trocadas</label><input type="text" id="f-manu-pecas"></div>
                </div>

                <div class="form-section">
                    <h3>Pend√™ncias</h3>
                    <div class="form-group"><label>Pend√™ncia de Servi√ßo</label><input type="text" id="f-pend-servico"></div>
                    <div class="form-group"><label>Pend√™ncia de Material</label><input type="text" id="f-pend-material"></div>
                </div>

                <div class="form-section">
                    <h3>Fotos & Observa√ß√µes</h3>
                    <div class="form-group"><label>Observa√ß√µes Gerais</label><textarea id="f-obs" rows="3"></textarea></div>
                    
                    <div class="photo-area">
                        <p>Adicionar Fotos</p>
                        <input type="file" accept="image/*" multiple onchange="app.handleImagePreview(event)">
                        <div id="image-preview-container" class="preview-container"></div>
                    </div>
                </div>

                <button type="submit" class="btn btn-success" style="width:100%; margin-top:20px;">Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>

    <div id="checklist-screen">
        <div class="chk-header">
            <h2>Novo Checklist de Manuten√ß√£o</h2>
            <button class="btn btn-danger" onclick="app.closeChecklist()">Fechar</button>
        </div>
        <div class="chk-body">
            <div class="chk-meta-grid">
                <div class="form-group"><label>Data</label><input type="date" id="chk-data"></div>
                <div class="form-group"><label>Hora In√≠cio</label><input type="time" id="chk-hora-inicio"></div>
                <div class="form-group"><label>Hora Fim</label><input type="time" id="chk-hora-fim"></div>
                <div class="form-group"><label>Torre</label><input type="text" id="chk-torre" placeholder="Ex: ER 01"></div>
                <div class="form-group"><label>Clima</label>
                    <select id="chk-clima">
                        <option>Ensolarado</option>
                        <option>Nublado</option>
                        <option>Chuvoso</option>
                    </select>
                </div>
                <div class="form-group"><label>Recurso (Ve√≠culo)</label><input type="text" id="chk-recurso"></div>
                <div class="form-group" style="grid-column: 1 / -1;"><label>Executantes</label><input type="text" id="chk-executantes"></div>
            </div>

            <div id="checklist-items-container">
                </div>

            <div class="signature-area">
                <h3>Assinatura do Respons√°vel</h3>
                <input type="text" id="chk-ass-nome" placeholder="Nome Leg√≠vel" style="width:100%; padding:8px; margin-bottom:10px;">
                <div class="signature-pad-wrapper">
                    <canvas id="signature-pad"></canvas>
                </div>
                <button class="btn btn-secondary" onclick="app.clearSignature()" style="margin-top:10px;">Limpar Assinatura</button>
            </div>

            <button class="btn btn-success" onclick="app.generateChecklistPDF()" style="width:100%; margin-top:30px; padding: 15px; font-size:18px;">Gerar PDF e Finalizar</button>
            <div style="height:50px"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script src="app.js"></script>

</body>
</html>
