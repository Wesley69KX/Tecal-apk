<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestão de Torres - V2</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0056b3">
    <link rel="icon" type="image/png" href="icon-192.png">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

    <div id="connection-status" class="status-badge online">Conectado</div>

    <div id="login-screen" class="fullscreen-center">
        <div class="login-box">
            <img id="login-logo-view" class="login-logo" src="" alt="Logo Empresa">
            <h2>Gestão de Torres</h2>
            <p style="color: #888; font-size:13px; margin-bottom:20px;">Acesso Restrito</p>
            <div class="input-group">
                <label>Usuário</label>
                <input type="text" id="login-user" placeholder="Digite seu usuário">
            </div>
            <div class="input-group">
                <label>Senha</label>
                <input type="password" id="login-pass" placeholder="Digite sua senha">
            </div>
            <button class="btn btn-primary" onclick="app.checkLogin()" style="width:100%; margin-top:10px;">
                <span class="material-icons">login</span> Entrar
            </button>
            <div style="margin: 20px 0; border-top: 1px solid #eee;"></div>
            <button class="btn btn-secondary" onclick="app.visitorLogin()" style="width:100%;">
                <span class="material-icons">visibility</span> Acesso Visitante
            </button>
        </div>
        <p style="color:white; font-size:11px; margin-top:20px; opacity:0.7">Versão 3.5 (Estrutura Public)</p>
    </div>

    <div id="location-screen" class="fullscreen-center hidden">
        <div class="login-box" style="max-width: 600px;">
            <h3 style="color:var(--primary)">Selecione a Unidade</h3>
            <p style="color:#666; font-size:14px; margin-bottom:25px;">Escolha a base operacional:</p>
            
            <div class="location-grid">
                <button class="btn-loc" onclick="app.selectLocation('MSG')">
                    <span class="material-icons" style="font-size:36px; color:#28a745; margin-bottom:8px;">dns</span>
                    MSG
                    <small>Crixás - GO</small>
                </button>
                <button class="btn-loc" onclick="app.selectLocation('QUEIROZ')">
                    <span class="material-icons" style="font-size:36px; color:#dc3545; margin-bottom:8px;">factory</span>
                    QUEIROZ
                    <small>Raposos - MG</small>
                </button>
                <button class="btn-loc" onclick="app.selectLocation('CUIABA')">
                    <span class="material-icons" style="font-size:36px; color:#ffc107; margin-bottom:8px;">terrain</span>
                    CUIABÁ
                    <small>Sabará - MG</small>
                </button>
                <button class="btn-loc" onclick="app.selectLocation('RPX')">
                    <span class="material-icons" style="font-size:36px; color:#17a2b8; margin-bottom:8px;">construction</span>
                    RPX
                    <small>Raposos - MG</small>
                </button>
                <button class="btn-loc" onclick="app.selectLocation('CDS')" style="grid-column: 1 / -1;">
                    <span class="material-icons" style="font-size:36px; color:#6f42c1; margin-bottom:8px;">engineering</span>
                    CDS
                    <small>Santa Bárbara - MG</small>
                </button>
            </div>
            
            <button class="btn btn-danger" onclick="location.reload()" style="margin-top: 30px; width:100%">
                <span class="material-icons">arrow_back</span> Sair
            </button>
        </div>
    </div>

    <div id="app-content">
        <div class="app-header">
            <div class="header-title">
                <h1>Painel de Controle</h1>
                <span>Unidade: <strong id="current-loc-badge" style="color:var(--primary)">---</strong></span>
            </div>
            <div class="header-controls">
                <button class="btn btn-danger" onclick="location.reload()" style="padding: 6px 12px; font-size: 12px;">
                    <span class="material-icons" style="font-size: 16px;">logout</span> Sair
                </button>
            </div>
        </div>

        <div class="toolbar">
            <div class="search-box">
                <span class="material-icons search-icon">search</span>
                <input type="text" id="search" placeholder="Buscar torre..." onkeyup="app.filterList()">
            </div>
            <div class="action-buttons">
                <button class="btn btn-success" id="btn-new-checklist" onclick="app.openChecklist()">
                    <span class="material-icons">playlist_add</span> Checklist
                </button>
                <button class="btn btn-primary" onclick="app.generateGlobalPDF()">
                    <span class="material-icons">description</span> Rel. Geral
                </button>
                <button class="btn btn-secondary" onclick="app.generateMonthlyPDF()">
                    <span class="material-icons">date_range</span> Rel. Mensal
                </button>
            </div>
        </div>

        <div class="stats-bar">
            <span>Total: <strong id="total-card" style="color:var(--dark)">0</strong></span>
            <span id="loading-msg" style="color: var(--primary); font-weight: bold; font-size:12px;">
                <span class="material-icons" style="font-size:12px; vertical-align:middle; animation: spin 1s infinite linear;">autorenew</span> Sincronizando...
            </span>
        </div>

        <div id="tower-list" class="tower-grid"></div>
    </div>

    <div id="checklist-screen">
        <div class="chk-header">
            <h3>Novo Checklist</h3>
            <button class="btn-danger" style="width:auto;" onclick="app.closeChecklist()">Fechar</button>
        </div>
        <div class="chk-body">
            <div class="form-section">
                <h3>Dados Iniciais</h3>
                <div class="form-row">
                    <div><label>Data</label><input type="date" id="chk-data"></div>
                    <div><label>Hora Início</label><input type="time" id="chk-hora-inicio"></div>
                </div>
                <div class="form-row">
                    <div><label>Hora Fim</label><input type="time" id="chk-hora-fim"></div>
                    <div><label>Torre</label><input type="text" id="chk-torre" placeholder="Ex: ER 01"></div>
                </div>
                <div class="form-row">
                    <div><label>Clima</label>
                        <select id="chk-clima">
                            <option>Ensolarado</option>
                            <option>Nublado</option>
                            <option>Chuvoso</option>
                        </select>
                    </div>
                    <div><label>Veículo</label><input type="text" id="chk-recurso"></div>
                </div>
                <label>Executantes</label><input type="text" id="chk-executantes">
            </div>

            <div id="checklist-items-container"></div>

            <div class="form-section">
                <h3>Assinatura</h3>
                <label>Nome do Responsável</label>
                <input type="text" id="chk-ass-nome">
                <div class="signature-pad-wrapper">
                    <canvas id="signature-pad"></canvas>
                </div>
                <button class="btn-secondary" onclick="app.clearSignature()" style="width:auto; margin-top:5px;">Limpar</button>
            </div>

            <button class="btn-success" onclick="app.generateChecklistPDF()" style="padding:15px; font-size:16px;">Gerar PDF e Finalizar</button>
            <div style="height: 50px;"></div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="app.closeModal()">&times;</span>
            <h2 style="color:var(--primary)">Editar Torre</h2>
            <form id="tower-form" onsubmit="app.saveTower(event)">
                <input type="hidden" id="tower-id">
                
                <div class="form-section">
                    <h3>Principal</h3>
                    <div class="form-row">
                        <div><label>Nome</label><input type="text" id="f-nome" required></div>
                        <div><label>Status</label>
                            <select id="f-status">
                                <option value="Operando">Operando</option>
                                <option value="Manutenção">Manutenção</option>
                                <option value="Falha">Falha</option>
                                <option value="Desativada">Desativada</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Geral</h3>
                    <div class="form-row">
                        <div><label>Localização</label><input type="text" id="f-geral-local"></div>
                        <div><label>Prioridade</label>
                            <select id="f-geral-prio">
                                <option>Baixa</option><option>Média</option><option>Alta</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div><label>Técnico</label><input type="text" id="f-geral-tec"></div>
                        <div><label>Última Com.</label><input type="datetime-local" id="f-geral-ultimacom"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Falhas</h3>
                    <label>Detectada</label><input type="text" id="f-falhas-detectada">
                    <label>Histórico</label><textarea id="f-falhas-historico" rows="2"></textarea>
                    <label>Ação</label><input type="text" id="f-falhas-acao">
                </div>

                <div class="form-section">
                    <h3>Manutenção</h3>
                    <div class="form-row">
                        <div><label>Última</label><input type="date" id="f-manu-ultima"></div>
                        <div><label>Próxima</label><input type="date" id="f-manu-proxima"></div>
                    </div>
                    <div class="form-row">
                        <div><label>Custo</label><input type="text" id="f-manu-custo"></div>
                        <div><label>Peças</label><input type="text" id="f-manu-pecas"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Pendências</h3>
                    <div class="form-row">
                        <div><label>Serviço</label><input type="text" id="f-pend-servico"></div>
                        <div><label>Material</label><input type="text" id="f-pend-material"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Fotos & Obs</h3>
                    <label>Observações</label><textarea id="f-obs" rows="3"></textarea>
                    <div class="photo-area">
                        <p>Adicionar Fotos</p>
                        <input type="file" accept="image/*" multiple onchange="app.handleImagePreview(event)">
                        <div id="image-preview-container" class="preview-container"></div>
                    </div>
                </div>

                <button type="submit" class="btn-success" style="padding:15px; font-size:16px;">Salvar Alterações</button>
            </form>
        </div>
    </div>

    <script src="app.js"></script>

</body>
</html>
