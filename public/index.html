<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gest√£o de Torres - V2</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #0056b3;       /* Azul Institucional */
            --secondary: #6c757d;     /* Cinza */
            --success: #28a745;       /* Verde */
            --danger: #dc3545;        /* Vermelho */
            --warning: #ffc107;       /* Amarelo */
            --light: #f8f9fa;         /* Fundo Claro */
            --dark: #343a40;          /* Texto Escuro */
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f0f2f5; 
            margin: 0; 
            padding: 0; 
            color: var(--dark);
        }
        
        /* --- Utilit√°rios --- */
        .hidden { display: none !important; }
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: 0.2s; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn:hover { opacity: 0.9; transform: scale(1.02); }
        .btn:active { transform: scale(0.98); }

        /* --- Status de Conex√£o --- */
        .status-badge { 
            position: fixed; 
            bottom: 10px; 
            right: 10px; 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: bold; 
            z-index: 9999; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .status-badge.online { background-color: var(--success); color: white; }
        .status-badge.offline { background-color: var(--secondary); color: white; }

        /* --- Telas de Login e Sele√ß√£o --- */
        .fullscreen-center { 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(135deg, #0056b3, #003d80); 
            color: white; 
            padding: 20px;
            box-sizing: border-box;
        }
        .login-box { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            color: var(--dark); 
            width: 100%; 
            max-width: 350px; 
            text-align: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        .login-logo { 
            max-width: 180px; 
            margin-bottom: 20px; 
            display: none; 
            margin-left: auto; 
            margin-right: auto; 
        }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: 600; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        .location-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-top: 20px; }
        .btn-loc { 
            padding: 15px; 
            font-size: 16px; 
            background: var(--light); 
            border: 2px solid var(--primary); 
            color: var(--primary); 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: 0.3s; 
        }
        .btn-loc:hover { background: var(--primary); color: white; }
        .btn-loc small { display: block; font-weight: normal; font-size: 12px; margin-top: 5px; }

        /* --- App Principal --- */
        #app-content { display: none; padding-bottom: 50px; }
        
        .app-header { 
            background: white; 
            padding: 15px 20px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
        }
        .header-title h1 { margin: 0; font-size: 20px; color: var(--primary); }
        .header-title span { font-size: 13px; color: var(--secondary); }
        
        .toolbar { 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 15px; 
            background-color: #e9ecef;
        }
        .search-box { flex: 1; min-width: 250px; }
        .search-box input { width: 100%; padding: 10px; border-radius: 20px; border: 1px solid #ccc; outline: none; padding-left: 15px; }
        
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }

        .stats-bar { padding: 10px 20px; font-size: 14px; color: var(--secondary); display: flex; justify-content: space-between; }

        /* --- Grid de Cards --- */
        .tower-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; 
            padding: 20px; 
        }
        .card { 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            overflow: hidden; 
            transition: transform 0.2s; 
            border-left: 6px solid var(--secondary); 
            display: flex;
            flex-direction: column;
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        
        /* Cores dos Status */
        .st-Operando { border-left-color: var(--success); }
        .st-Falha { border-left-color: var(--danger); }
        .st-Manuten√ß√£o { border-left-color: var(--warning); }
        .st-Desativada { border-left-color: var(--secondary); }

        .card-header { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .status-pill { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; background: #f0f2f5; color: var(--dark); border: 1px solid #ddd; }
        
        .warning-alert { background: #fff3cd; color: #856404; padding: 8px 15px; font-size: 12px; border-bottom: 1px solid #ffeeba; display: flex; align-items: center; gap: 5px; font-weight: bold; }
        
        .card-body { padding: 15px; font-size: 13px; flex-grow: 1; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-item { display: flex; flex-direction: column; }
        .info-label { color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-value { font-weight: 600; color: #333; }
        .text-red { color: var(--danger); font-weight: bold; }
        
        .divider { grid-column: 1 / -1; height: 1px; background: #eee; margin: 8px 0; }
        .obs-box { margin-top: 10px; background: #f8f9fa; padding: 10px; border-radius: 6px; font-style: italic; color: #555; border: 1px dashed #ccc; font-size: 12px; }

        .card-footer { padding: 12px 15px; background: #fafafa; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 8px; }
        .btn-card { padding: 6px 12px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.2s; }
        .btn-card:hover { background-color: #eee; }
        .btn-edit { color: var(--primary); border-color: var(--primary); }
        .btn-edit:hover { background-color: var(--primary); color: white; }
        .btn-pdf-single { color: var(--danger); border-color: var(--danger); }
        .btn-pdf-single:hover { background-color: var(--danger); color: white; }

        /* --- Modal --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; backdrop-filter: blur(2px); }
        .modal-content { background: white; margin: 30px auto; padding: 25px; width: 90%; max-width: 800px; border-radius: 10px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .close { position: absolute; right: 20px; top: 15px; font-size: 28px; cursor: pointer; color: #aaa; transition: 0.2s; }
        .close:hover { color: var(--danger); }
        
        .form-section { margin-bottom: 25px; border: 1px solid #e0e0e0; padding: 20px; border-radius: 8px; background: #fff; }
        .form-section h3 { margin-top: 0; color: var(--primary); font-size: 16px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 10px; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        .form-group input:focus { border-color: var(--primary); outline: none; }
        
        .photo-area { margin-top: 10px; border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; background: #fafafa; }
        .preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; justify-content: center; }
        .photo-wrapper { position: relative; width: 100px; height: 100px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .img-preview { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .btn-delete-photo { position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; border-radius: 50%; width: 24px; height: 24px; text-align: center; line-height: 22px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* --- Checklist --- */
        #checklist-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f6f8; z-index: 2000; flex-direction: column; overflow-y: auto; }
        .chk-header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chk-body { padding: 20px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; background: white; margin-top: 20px; border-radius: 10px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); margin-bottom: 40px; }
        
        .chk-meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
        
        .check-section { background: #e9ecef; padding: 10px 15px; margin: 25px 0 10px 0; font-weight: bold; border-radius: 5px; color: var(--dark); border-left: 5px solid var(--primary); }
        .chk-row { display: flex; flex-wrap: wrap; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; gap: 15px; }
        .chk-row:last-child { border-bottom: none; }
        .chk-title { flex: 2; min-width: 250px; font-size: 14px; font-weight: 500; }
        .chk-controls { flex: 1; min-width: 180px; }
        .chk-comment { flex: 1; min-width: 180px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        
        .radio-group { display: flex; gap: 15px; background: #fff; padding: 5px; border-radius: 20px; border: 1px solid #eee; width: fit-content; }
        .radio-label { font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; padding: 2px 8px; border-radius: 15px; transition: 0.2s; }
        .radio-label:hover { background-color: #f0f0f0; }
        
        .signature-area { margin-top: 40px; border: 1px solid #ccc; padding: 20px; border-radius: 8px; background: #fafafa; }
        .signature-pad-wrapper { border: 2px dashed #999; height: 200px; background: #fff; position: relative; margin-top: 15px; border-radius: 5px; touch-action: none; }
        canvas { width: 100%; height: 100%; display: block; }

        /* Responsividade Mobile */
        @media (max-width: 768px) {
            .toolbar { flex-direction: column; align-items: stretch; }
            .action-buttons { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            .modal-content { width: 100%; margin: 0; height: 100%; border-radius: 0; }
            .chk-body { margin-top: 0; border-radius: 0; }
        }
    </style>
</head>
<body>

    <div id="connection-status" class="status-badge online">Conectado</div>

    <div id="login-screen" class="fullscreen-center">
        <div class="login-box">
            <img id="login-logo-view" class="login-logo" src="" alt="Logo Empresa">
            <h2>Gest√£o de Torres</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Acesso ao Sistema de Manuten√ß√£o</p>
            
            <div class="input-group">
                <label>Usu√°rio</label>
                <input type="text" id="login-user" placeholder="Digite seu usu√°rio">
            </div>
            <div class="input-group">
                <label>Senha</label>
                <input type="password" id="login-pass" placeholder="Digite sua senha">
            </div>
            
            <button class="btn btn-primary" onclick="app.checkLogin()" style="width:100%">
                <span class="material-icons">login</span> Entrar
            </button>
            
            <hr style="margin: 20px 0; border-color: #eee;">
            
            <button class="btn btn-secondary" onclick="app.visitorLogin()" style="width:100%">
                <span class="material-icons">visibility</span> Acesso Visitante
            </button>
        </div>
        <p style="margin-top: 20px; font-size: 12px; opacity: 0.7;">Vers√£o 2.5 - Baseada em Localiza√ß√£o</p>
    </div>

    <div id="location-screen" class="fullscreen-center hidden">
        <div class="login-box" style="max-width: 600px;">
            <h3>Selecione a Unidade</h3>
            <p style="color:#666; margin-bottom:25px">Escolha a base operacional para carregar os dados:</p>
            
            <div class="location-grid">
                <button class="btn-loc" onclick="app.selectLocation('MSG')">
                    <span class="material-icons" style="font-size:30px; display:block; margin-bottom:5px;">dns</span>
                    MSG
                    <small>Crix√°s - GO</small>
                </button>
                <button class="btn-loc" onclick="app.selectLocation('QUEIROZ')">
                    <span class="material-icons" style="font-size:30px; display:block; margin-bottom:5px;">factory</span>
                    QUEIROZ
                    <small>Raposos - MG</small>
                </button>
                <button class="btn-loc" onclick="app.selectLocation('CUIABA')">
                    <span class="material-icons" style="font-size:30px; display:block; margin-bottom:5px;">terrain</span>
                    CUIAB√Å
                    <small>Sabar√° - MG</small>
                </button>
                <button class="btn-loc" onclick="app.selectLocation('RPX')">
                    <span class="material-icons" style="font-size:30px; display:block; margin-bottom:5px;">construction</span>
                    RPX
                    <small>Raposos - MG</small>
                </button>
            </div>
            
            <button class="btn btn-danger" style="margin-top:30px; width: 100%;" onclick="location.reload()">
                <span class="material-icons">arrow_back</span> Voltar / Sair
            </button>
        </div>
    </div>

    <div id="app-content">
        <div class="app-header">
            <div class="header-title">
                <h1>Painel de Controle</h1>
                <span>Unidade Conectada: <strong id="current-loc-badge" style="color:var(--primary)">---</strong></span>
            </div>
            <div class="header-controls">
                <button class="btn btn-danger" onclick="location.reload()" style="padding: 5px 10px; font-size: 12px;">
                    <span class="material-icons" style="font-size: 16px;">logout</span> Sair
                </button>
            </div>
        </div>

        <div class="toolbar">
            <div class="search-box">
                <input type="text" id="search" placeholder="üîç Buscar torre pelo nome..." onkeyup="app.filterList()">
            </div>
            <div class="action-buttons">
                <button class="btn btn-success" id="btn-new-checklist" onclick="app.openChecklist()">
                    <span class="material-icons">playlist_add</span> Novo Checklist
                </button>
                <button class="btn btn-primary" onclick="app.generateGlobalPDF()">
                    <span class="material-icons">picture_as_pdf</span> Relat√≥rio Geral
                </button>
                <button class="btn btn-secondary" onclick="app.generateMonthlyPDF()">
                    <span class="material-icons">calendar_today</span> Relat√≥rio Mensal
                </button>
            </div>
        </div>

        <div class="stats-bar">
            <span>Total de Torres: <strong id="total-card">0</strong></span>
            <span id="loading-msg" style="color: var(--primary); font-weight: bold;">
                <span class="material-icons" style="font-size:12px; vertical-align:middle; animation: spin 1s infinite linear;">autorenew</span> Sincronizando dados...
            </span>
        </div>

        <div id="tower-list" class="tower-grid">
            </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="app.closeModal()">&times;</span>
            <h2 style="border-bottom: 2px solid var(--primary); padding-bottom: 10px; color: var(--primary);">
                <span class="material-icons" style="vertical-align: middle;">edit</span> Editar Torre
            </h2>
            <form id="tower-form" onsubmit="app.saveTower(event)">
                <input type="hidden" id="tower-id">
                
                <div class="form-section">
                    <h3>Identifica√ß√£o & Status</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nome da Torre</label>
                            <input type="text" id="f-nome" required>
                        </div>
                        <div class="form-group">
                            <label>Status Atual</label>
                            <select id="f-status">
                                <option value="Operando">Operando (Verde)</option>
                                <option value="Manuten√ß√£o">Manuten√ß√£o (Amarelo)</option>
                                <option value="Falha">Falha (Vermelho)</option>
                                <option value="Desativada">Desativada (Cinza)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Informa√ß√µes Gerais</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Localiza√ß√£o (Lat/Long ou Ref)</label><input type="text" id="f-geral-local"></div>
                        <div class="form-group"><label>Prioridade</label>
                            <select id="f-geral-prio">
                                <option value="Baixa">Baixa</option>
                                <option value="M√©dia">M√©dia</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        <div class="form-group"><label>T√©cnico Respons√°vel</label><input type="text" id="f-geral-tec"></div>
                        <div class="form-group"><label>√öltima Comunica√ß√£o (Data/Hora)</label><input type="datetime-local" id="f-geral-ultimacom"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Controle de Falhas</h3>
                    <div class="form-group"><label>Falha Detectada (Descri√ß√£o Curta)</label><input type="text" id="f-falhas-detectada" placeholder="Ex: R√°dio inoperante"></div>
                    <div class="form-group"><label>Hist√≥rico da Falha</label><textarea id="f-falhas-historico" rows="2"></textarea></div>
                    <div class="form-group"><label>A√ß√£o Corretiva Tomada</label><input type="text" id="f-falhas-acao"></div>
                </div>

                <div class="form-section">
                    <h3>Dados de Manuten√ß√£o</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Data √öltima Manut.</label><input type="date" id="f-manu-ultima"></div>
                        <div class="form-group"><label>Previs√£o Pr√≥xima</label><input type="date" id="f-manu-proxima"></div>
                        <div class="form-group"><label>Custo Estimado (R$)</label><input type="text" id="f-manu-custo"></div>
                    </div>
                    <div class="form-group"><label>Pe√ßas Trocadas/Utilizadas</label><input type="text" id="f-manu-pecas"></div>
                </div>

                <div class="form-section">
                    <h3>Pend√™ncias</h3>
                    <div class="form-group"><label>Pend√™ncia de Servi√ßo</label><input type="text" id="f-pend-servico"></div>
                    <div class="form-group"><label>Pend√™ncia de Material</label><input type="text" id="f-pend-material"></div>
                </div>

                <div class="form-section">
                    <h3>Fotos & Observa√ß√µes</h3>
                    <div class="form-group"><label>Observa√ß√µes Gerais</label><textarea id="f-obs" rows="3"></textarea></div>
                    
                    <div class="photo-area">
                        <p style="margin-bottom: 10px; font-weight: bold; color: #666;">
                            <span class="material-icons" style="vertical-align: middle;">add_a_photo</span> Adicionar Fotos
                        </p>
                        <input type="file" accept="image/*" multiple onchange="app.handleImagePreview(event)">
                        <div id="image-preview-container" class="preview-container"></div>
                    </div>
                </div>

                <button type="submit" class="btn btn-success" style="width:100%; margin-top:20px; padding: 15px; font-size: 16px;">
                    <span class="material-icons">save</span> Salvar Altera√ß√µes
                </button>
            </form>
        </div>
    </div>

    <div id="checklist-screen">
        <div class="chk-header">
            <h2 style="margin:0; font-size: 18px;"><span class="material-icons" style="vertical-align:middle">assignment</span> Novo Checklist</h2>
            <button class="btn btn-danger" onclick="app.closeChecklist()">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="chk-body">
            <div class="chk-meta-grid">
                <div class="form-group"><label>Data</label><input type="date" id="chk-data"></div>
                <div class="form-group"><label>Hora In√≠cio</label><input type="time" id="chk-hora-inicio"></div>
                <div class="form-group"><label>Hora Fim</label><input type="time" id="chk-hora-fim"></div>
                <div class="form-group"><label>Torre / Equipamento</label><input type="text" id="chk-torre" placeholder="Ex: ER 01"></div>
                <div class="form-group"><label>Condi√ß√µes Clim√°ticas</label>
                    <select id="chk-clima">
                        <option>Ensolarado</option>
                        <option>Nublado</option>
                        <option>Chuvoso</option>
                        <option>Vento Forte</option>
                    </select>
                </div>
                <div class="form-group"><label>Recurso (Ve√≠culo/Placa)</label><input type="text" id="chk-recurso"></div>
                <div class="form-group" style="grid-column: 1 / -1;"><label>Nomes dos Executantes</label><input type="text" id="chk-executantes"></div>
            </div>

            <div id="checklist-items-container">
                </div>

            <div class="signature-area">
                <h3><span class="material-icons" style="vertical-align:middle">draw</span> Assinatura do Respons√°vel</h3>
                <input type="text" id="chk-ass-nome" placeholder="Digite seu nome completo" style="width:100%; padding:10px; margin-bottom:10px; border: 1px solid #ccc; border-radius: 4px;">
                <div class="signature-pad-wrapper">
                    <canvas id="signature-pad"></canvas>
                </div>
                <button class="btn btn-secondary" onclick="app.clearSignature()" style="margin-top:10px; font-size: 12px;">Limpar Assinatura</button>
            </div>

            <button class="btn btn-success" onclick="app.generateChecklistPDF()" style="width:100%; margin-top:30px; padding: 15px; font-size:18px;">
                <span class="material-icons">picture_as_pdf</span> Gerar PDF e Finalizar
            </button>
            <div style="height:50px"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script src="app.js"></script>

</body>
</html>
